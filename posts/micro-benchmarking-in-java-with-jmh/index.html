<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Micro benchmarking in Java with JMH | Delcastanher's Memory Allocation</title>
<meta name=keywords content="Java"><meta name=description content="How Java Microbenchmark Harness works and how to use it in your current project."><meta name=author content="Ricardo Delcastanher"><link rel=canonical href=https://delcastanher.github.io/posts/micro-benchmarking-in-java-with-jmh/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://delcastanher.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://delcastanher.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://delcastanher.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://delcastanher.github.io/apple-touch-icon.png><link rel=mask-icon href=https://delcastanher.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Micro benchmarking in Java with JMH"><meta property="og:description" content="How Java Microbenchmark Harness works and how to use it in your current project."><meta property="og:type" content="article"><meta property="og:url" content="https://delcastanher.github.io/posts/micro-benchmarking-in-java-with-jmh/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-12T11:36:09-03:00"><meta property="article:modified_time" content="2022-07-12T11:36:09-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Micro benchmarking in Java with JMH"><meta name=twitter:description content="How Java Microbenchmark Harness works and how to use it in your current project."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://delcastanher.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Micro benchmarking in Java with JMH","item":"https://delcastanher.github.io/posts/micro-benchmarking-in-java-with-jmh/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Micro benchmarking in Java with JMH","name":"Micro benchmarking in Java with JMH","description":"How Java Microbenchmark Harness works and how to use it in your current project.","keywords":["Java"],"articleBody":"Java Microbenchmark Harness (JMH) is a Java harness for building, running, and analyzing nano/micro/milli/macro benchmarks written in Java and other languages targeting the JVM. 1\nWhat is benchmarking? 2 Suppose you have a code snippet and want to test its execution time. What to do?\nThe easiest way for that is, find the current millisecond before the method and also find the current millisecond after the method. Then find the difference between both which is the execution time for that particular method.\nAnd, if you want to make the result more accurate, run the method several times and need to find out the average of all execution.\nAnd what is micro benchmarking? Its called “micro” because it uses the microseconds scale to measure the time execution. 3\nHowever, its scale is configurable in JMH.\nStressing critical portions of code and obtaining metrics that are meaningful is actually difficult in the Java Virtual Machine (JVM) world, because the JVM is an adaptive virtual machine. As we see in this article, the JVM does many optimizations that render the simplest benchmark irrelevant unless many precautions are taken.\nJMH was developed as part of the OpenJDK project and provides a very solid foundation for writing and running benchmarks whose results are not erroneous due to unwanted virtual machine optimizations. It does not prevent the JVM pitfalls but greatly helps mitigate them. 4\nUsing JMH in your project Add JMH Core and JMH Generators: Annotation Processors dependencies on Maven.\norg.openjdk.jmh jmh-core 1.35 org.openjdk.jmh jmh-generator-annprocess 1.35 test Update maven-compiler-plugin, adding annotationProcessorPaths, and exec-maven-plugin. 5\nmaven-compiler-plugin 3.8.0 1.8 1.8 org.openjdk.jmh jmh-generator-annprocess 1.35 org.codehaus.mojo exec-maven-plugin run-benchmarks integration-test exec test java -classpath ","wordCount":"343","inLanguage":"en","datePublished":"2022-07-12T11:36:09-03:00","dateModified":"2022-07-12T11:36:09-03:00","author":{"@type":"Person","name":"Ricardo Delcastanher"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://delcastanher.github.io/posts/micro-benchmarking-in-java-with-jmh/"},"publisher":{"@type":"Organization","name":"Delcastanher's Memory Allocation","logo":{"@type":"ImageObject","url":"https://delcastanher.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://delcastanher.github.io/ accesskey=h title="Delcastanher's Memory Allocation (Alt + H)">Delcastanher's Memory Allocation</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Micro benchmarking in Java with JMH</h1><div class=post-meta><span title='2022-07-12 11:36:09 -0300 -0300'>July 12, 2022</span>&nbsp;·&nbsp;Ricardo Delcastanher</div></header><div class=post-content><p><a href=https://github.com/openjdk/jmh>Java Microbenchmark Harness (JMH)</a> is a Java harness for building, running, and analyzing nano/micro/milli/macro benchmarks written in Java and other languages targeting the JVM. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><h2 id=what-is-benchmarking-2>What is benchmarking? <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup><a hidden class=anchor aria-hidden=true href=#what-is-benchmarking-2>#</a></h2><p>Suppose you have a code snippet and want to test its execution time. What to do?</p><p>The easiest way for that is, find the current millisecond before the method and also find the current millisecond after the method. Then find the difference between both which is the execution time for that particular method.</p><p>And, if you want to make the result more accurate, run the method several times and need to find out the average of all execution.</p><h2 id=and-what-is-micro-benchmarking>And what is micro benchmarking?<a hidden class=anchor aria-hidden=true href=#and-what-is-micro-benchmarking>#</a></h2><p>Its called &ldquo;micro&rdquo; because it uses the microseconds scale to measure the time execution. <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p>However, its scale is configurable in JMH.</p><p>Stressing critical portions of code and obtaining metrics that are meaningful is actually difficult in the Java Virtual Machine (JVM) world, because the JVM is an adaptive virtual machine. As we see in <a href=https://www.oracle.com/technical-resources/articles/java/architect-benchmarking.html>this article</a>, the JVM does many optimizations that render the simplest benchmark irrelevant unless many precautions are taken.</p><p>JMH was developed as part of the OpenJDK project and provides a very solid foundation for writing and running benchmarks whose results are not erroneous due to unwanted virtual machine optimizations. It does not prevent the JVM pitfalls but greatly helps mitigate them. <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><h2 id=using-jmh-in-your-project>Using JMH in your project<a hidden class=anchor aria-hidden=true href=#using-jmh-in-your-project>#</a></h2><p>Add <a href=https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-core>JMH Core</a> and <a href=https://mvnrepository.com/artifact/org.openjdk.jmh/jmh-generator-annprocess>JMH Generators: Annotation Processors</a> dependencies on Maven.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.openjdk.jmh<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>jmh-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.35<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.openjdk.jmh<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>jmh-generator-annprocess<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.35<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Update <code>maven-compiler-plugin</code>, adding <code>annotationProcessorPaths</code>, and <code>exec-maven-plugin</code>. <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=display:flex><span><span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>maven-compiler-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>3.8.0<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;source&gt;</span>1.8<span style=color:#f92672>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;target&gt;</span>1.8<span style=color:#f92672>&lt;/target&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;annotationProcessorPaths&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;path&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;groupId&gt;</span>org.openjdk.jmh<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;artifactId&gt;</span>jmh-generator-annprocess<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;version&gt;</span>1.35<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/path&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/annotationProcessorPaths&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.codehaus.mojo<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>exec-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;id&gt;</span>run-benchmarks<span style=color:#f92672>&lt;/id&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;phase&gt;</span>integration-test<span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;goal&gt;</span>exec<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;classpathScope&gt;</span>test<span style=color:#f92672>&lt;/classpathScope&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;executable&gt;</span>java<span style=color:#f92672>&lt;/executable&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;arguments&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;argument&gt;</span>-classpath<span style=color:#f92672>&lt;/argument&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;classpath</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;argument&gt;</span>org.openjdk.jmh.Main<span style=color:#f92672>&lt;/argument&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;argument&gt;</span>.*<span style=color:#f92672>&lt;/argument&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/arguments&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>Add the <strong><code>@Benchmark</code></strong> annotation to the methods on your project that you want to benchmark and run the code below to take the results. <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>Options opt <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OptionsBuilder()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>include</span>(<span style=color:#e6db74>&#34;.*&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>forks</span>(1)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> Runner(opt).<span style=color:#a6e22e>run</span>();
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/openjdk/jmh>https://github.com/openjdk/jmh</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://medium.com/javarevisited/understanding-java-microbenchmark-harness-or-jmh-tool-5b9b90ccbe8d>https://medium.com/javarevisited/understanding-java-microbenchmark-harness-or-jmh-tool-5b9b90ccbe8d</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://vimeo.com/78900556>https://vimeo.com/78900556</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.oracle.com/technical-resources/articles/java/architect-benchmarking.html>https://www.oracle.com/technical-resources/articles/java/architect-benchmarking.html</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://stackoverflow.com/a/62983884>https://stackoverflow.com/a/62983884</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/openjdk/jmh/blob/master/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_01_HelloWorld.java>https://github.com/openjdk/jmh/blob/master/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_01_HelloWorld.java</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://delcastanher.github.io/tags/java/>Java</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://delcastanher.github.io/>Delcastanher's Memory Allocation</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>